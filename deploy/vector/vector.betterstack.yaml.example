data_dir: /var/lib/vector

sources:
  active_workbench_runtime:
    type: file
    include:
      - /var/lib/active-workbench/data/logs/active-workbench.log
    read_from: end

  active_workbench_telemetry:
    type: file
    include:
      - /var/lib/active-workbench/data/logs/active-workbench-telemetry.log
    read_from: end

  nginx_access:
    type: file
    include:
      - /var/log/nginx/access.log
    read_from: end

  nginx_error:
    type: file
    include:
      - /var/log/nginx/error.log
    read_from: end

  opencode_journal:
    type: journald
    include_units:
      - opencode-serve.service
    current_boot_only: true
    since_now: true

transforms:
  tag_active_workbench_runtime:
    type: remap
    inputs:
      - active_workbench_runtime
    source: |
      .service = "active-workbench-backend"
      .log_stream = "runtime"
      .environment = get_env_var("ACTIVE_WORKBENCH_DEPLOYMENT_ENV") ?? "production"
      .host = get_env_var("HOSTNAME") ?? "unknown"
      .dt = del(.timestamp)

  tag_active_workbench_telemetry:
    type: remap
    inputs:
      - active_workbench_telemetry
    source: |
      .service = "active-workbench-backend"
      .log_stream = "telemetry"
      .environment = get_env_var("ACTIVE_WORKBENCH_DEPLOYMENT_ENV") ?? "production"
      .host = get_env_var("HOSTNAME") ?? "unknown"
      .dt = del(.timestamp)

  tag_nginx_access:
    type: remap
    inputs:
      - nginx_access
    source: |
      .service = "nginx"
      .log_stream = "access"
      .environment = get_env_var("ACTIVE_WORKBENCH_DEPLOYMENT_ENV") ?? "production"
      .host = get_env_var("HOSTNAME") ?? "unknown"
      .dt = del(.timestamp)

  tag_nginx_error:
    type: remap
    inputs:
      - nginx_error
    source: |
      .service = "nginx"
      .log_stream = "error"
      .environment = get_env_var("ACTIVE_WORKBENCH_DEPLOYMENT_ENV") ?? "production"
      .host = get_env_var("HOSTNAME") ?? "unknown"
      .dt = del(.timestamp)

  tag_opencode_journal:
    type: remap
    inputs:
      - opencode_journal
    source: |
      .service = "opencode-serve"
      .log_stream = "journald"
      .environment = get_env_var("ACTIVE_WORKBENCH_DEPLOYMENT_ENV") ?? "production"
      .host = get_env_var("HOSTNAME") ?? "unknown"
      .dt = del(.timestamp)

sinks:
  better_stack:
    type: http
    inputs:
      - tag_active_workbench_runtime
      - tag_active_workbench_telemetry
      - tag_nginx_access
      - tag_nginx_error
      - tag_opencode_journal
    uri: "https://${BETTER_STACK_INGESTING_HOST}/"
    method: post
    compression: gzip
    encoding:
      codec: json
    auth:
      strategy: bearer
      token: "${BETTER_STACK_SOURCE_TOKEN}"
